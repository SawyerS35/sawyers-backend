<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YÃ¶netici Paneli - SawyerS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        
        /* SOL MENÃœ (SIDEBAR) */
        .sidebar { height: 100vh; background: #212529; color: white; padding: 20px; position: fixed; width: 250px; left: 0; top: 0; overflow-y: auto;}
        .sidebar h3 { font-size: 22px; font-weight: bold; margin-bottom: 30px; border-bottom: 1px solid #4b545c; padding-bottom: 10px; color: #ffc107; }
        .menu-link { display: block; padding: 12px 15px; color: #c2c7d0; text-decoration: none; border-radius: 5px; margin-bottom: 5px; transition: 0.2s; font-size: 15px; }
        .menu-link:hover, .menu-link.active { background-color: #0d6efd; color: white; }
        .menu-link i { margin-right: 10px; width: 20px; text-align: center; }
        
        /* SAÄ TARAF (Ä°Ã‡ERÄ°K) */
        .main-content { margin-left: 250px; padding: 30px; }
        
        /* Ä°STATÄ°STÄ°K KARTLARI */
        .stats-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; border-left: 5px solid #0d6efd; }
        .stats-number { font-size: 32px; font-weight: bold; color: #333; }
        .stats-label { color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .stats-icon { font-size: 45px; opacity: 0.2; color: #0d6efd; }
        
        /* TABLO KARTI */
        .table-card { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; margin-top: 30px; }
        .table-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        
        /* RESÄ°M AYARI */
        .table-img { width: 60px; height: 50px; object-fit: cover; border-radius: 5px; border: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>âš¡ Admin Panel</h3>
        <div class="mb-4 text-white-50 small">HoÅŸgeldin, YÃ¶netici</div>
        
        <a href="#" class="menu-link active"><i class="fa-solid fa-gauge"></i> Ä°lan YÃ¶netimi</a>
        <a href="index.html" class="menu-link"><i class="fa-solid fa-earth-americas"></i> Siteye DÃ¶n</a>
        
        <div style="margin-top: 50px; border-top: 1px solid #444; padding-top: 20px;">
            <a href="#" id="logoutBtn" class="menu-link text-danger"><i class="fa-solid fa-right-from-bracket"></i> Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
    </div>

    <div class="main-content">
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div>
                        <div class="stats-number" id="totalAds">0</div>
                        <div class="stats-label">YayÄ±ndaki Ä°lan</div>
                    </div>
                    <i class="fa-solid fa-layer-group stats-icon"></i>
                </div>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header">
                <h5 class="m-0 fw-bold text-secondary"><i class="fa-solid fa-list"></i> TÃ¼m Ä°lanlar</h5>
                <button onclick="loadAds()" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-rotate"></i> Yenile</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="80">GÃ¶rsel</th>
                            <th>BaÅŸlÄ±k & Kategori</th>
                            <th>Fiyat</th>
                            <th>SatÄ±cÄ±</th>
                            <th>Tarih</th>
                            <th class="text-end">Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody id="adsTableBody">
                        <tr><td colspan="6" class="text-center p-4 text-muted">Veriler yÃ¼kleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 1. ADMÄ°N MÄ°? (GÃœVENLÄ°K)
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            
            if (!isAdmin) {
                alert("â›” Yetkisiz GiriÅŸ! Ana sayfaya yÃ¶nlendiriliyorsunuz.");
                window.location.href = "index.html";
                return;
            }

            // Ä°lanlarÄ± Ã‡ek
            loadAds();

            // Ã‡Ä±kÄ±ÅŸ Butonu
            document.getElementById('logoutBtn').onclick = () => {
                if(confirm("Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?")) {
                    localStorage.removeItem('userLoggedIn');
                    localStorage.removeItem('isAdmin');
                    localStorage.removeItem('userId');
                    window.location.href = "giris.html";
                }
            }
        });

        // --- Ä°LANLARI GETÄ°RME FONKSÄ°YONU ---
        async function loadAds() {
            const tableBody = document.getElementById('adsTableBody');
            const counter = document.getElementById('totalAds');
            
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-3">â³ YÃ¼kleniyor...</td></tr>';

            try {
                // API'ye Ä°stek At
                console.log("Ä°lanlar isteniyor...");
                
                // DÃœZELTME 1: fetch=('...') yerine fetch('...') yapÄ±ldÄ±.
                const res = await fetch('https://sawyers-backend.onrender.com/api/ilanlar');
                
                if (!res.ok) throw new Error("Sunucu hatasÄ±: " + res.status);
                
                const ads = await res.json();
                console.log("Gelen Ä°lanlar:", ads);

                // SayÄ±yÄ± GÃ¼ncelle
                counter.innerText = ads.length;
                tableBody.innerHTML = ''; // Tabloyu temizle

                // EÄŸer hiÃ§ ilan yoksa
                if(ads.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center p-5 text-muted">
                                <i class="fa-regular fa-folder-open fs-1 mb-3"></i><br>
                                HenÃ¼z hiÃ§ ilan eklenmemiÅŸ.
                            </td>
                        </tr>`;
                    return;
                }

                // Ä°lanlarÄ± DÃ¶ngÃ¼ye Sok
                ads.forEach(ad => {
                    // Veri GÃ¼venliÄŸi
                    const title = ad.title || "BaÅŸlÄ±ksÄ±z Ä°lan";
                    const price = ad.price ? Number(ad.price).toLocaleString('tr-TR') : "0";
                    const seller = ad.sellerName || "Bilinmiyor";
                    const category = ad.category || "Genel";
                    const date = ad.date ? new Date(ad.date).toLocaleDateString('tr-TR') : "-";
                    
                    // Resim KontrolÃ¼
                    // DÃœZELTME 2: src iÃ§indeki hatalÄ± "fetch(" yazÄ±sÄ± kaldÄ±rÄ±ldÄ± ve doÄŸru URL formatÄ± yapÄ±ldÄ±.
                    let imgHtml = '<div style="width:60px; height:50px; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:5px;">ğŸ“·</div>';
                    if (ad.images && ad.images.length > 0) {
                        imgHtml = `<img src="https://sawyers-backend.onrender.com/uploads/${ad.images[0]}" class="table-img" alt="img">`;
                    }

                    const row = `
                        <tr>
                            <td>${imgHtml}</td>
                            <td>
                                <div class="fw-bold text-dark">${title}</div>
                                <span class="badge bg-light text-secondary border">${category}</span>
                            </td>
                            <td class="fw-bold text-primary">${price} TL</td>
                            <td>
                                <i class="fa-regular fa-user small text-muted"></i> ${seller}
                            </td>
                            <td class="small text-muted">${date}</td>
                            <td class="text-end">
                                <button onclick="deleteAd('${ad._id}')" class="btn btn-sm btn-outline-danger">
                                    <i class="fa-solid fa-trash"></i> Sil
                                </button>
                                <a href="ilan-detay.html?id=${ad._id}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                    <i class="fa-solid fa-eye"></i>
                                </a>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

            } catch (err) {
                console.error("HATA:", err);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger p-3">âš ï¸ Veriler yÃ¼klenemedi. (Sunucu aÃ§Ä±k mÄ±?)</td></tr>`;
            }
        }

        // --- Ä°LAN SÄ°LME FONKSÄ°YONU ---
        async function deleteAd(adId) {
            if(!confirm("âš ï¸ DÄ°KKAT: YÃ¶netici yetkisiyle bu ilanÄ± kalÄ±cÄ± olarak silmek Ã¼zeresiniz. OnaylÄ±yor musunuz?")) return;

            const adminId = localStorage.getItem('userId');

            try {
                // Silme Ä°steÄŸi
                // DÃœZELTME 3: HatalÄ± tÄ±rnak iÅŸaretleri ve URL birleÅŸtirmesi dÃ¼zeltildi.
                const res = await fetch(`https://sawyers-backend.onrender.com/api/ilanlar/${adId}/${adminId}`, {
                    method: 'DELETE'
                });

                if(res.ok) {
                    alert("âœ… Ä°lan baÅŸarÄ±yla silindi.");
                    loadAds(); // Listeyi yenile
                } else {
                    const data = await res.json();
                    alert("âŒ Hata: " + (data.error || "Silinemedi"));
                }
            } catch (err) {
                alert("Sunucu hatasÄ±");
            }
        }
    </script>
</body>
</html>