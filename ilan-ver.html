<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√úcretsiz ƒ∞lan Olu≈ütur - SawyerS 2.el</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. GENEL SAYFA AYARLARI --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ede7f6 0%, #e3f2fd 100%);
            margin: 0; padding: 0; color: #333; min-height: 100vh;
        }

        /* --- 2. HEADER --- */
        .site-header {
            background-color: #2962ff;
            padding: 15px 40px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(41, 98, 255, 0.2);
            position: sticky; top: 0; z-index: 1000;
        }
        .header-logo { font-size: 24px; font-weight: 800; color: white; text-decoration: none; letter-spacing: -0.5px; }
        .header-menu { display: flex; align-items: center; gap: 30px; }
        .menu-item { color: white; text-decoration: none; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: opacity 0.2s; }
        .menu-item:hover { opacity: 0.85; }

        /* --- 3. FORM KAPSAYICISI --- */
        .main-content-wrapper {
            max-width: 850px; margin: 40px auto; padding: 0 20px 50px 20px;
        }

        /* --- 4. FORM STƒ∞LLERƒ∞ --- */
        h1.page-title { text-align: left; color: #6a1b9a; margin-bottom: 30px; font-weight: 800; }

        .form-card {
            background: white; border-radius: 12px; border-top: 4px solid #6a1b9a;
            box-shadow: 0 6px 20px rgba(106, 27, 154, 0.1); padding: 30px;
            width: 100%; box-sizing: border-box; margin-bottom: 25px;
            border-bottom: 1px solid #eaeaea; border-left: 1px solid #eaeaea; border-right: 1px solid #eaeaea;
        }
        .section-title { font-size: 18px; font-weight: 700; color: #6a1b9a; margin-bottom: 20px; border-bottom: 2px solid #f5f5f5; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; position: relative; }
        .label-text { display: block; font-size: 14px; margin-bottom: 8px; font-weight: 600; color: #555; }
        
        .std-input, .std-textarea {
            width: 100%; padding: 12px 15px; border: 2px solid #eee; border-radius: 8px;
            font-size: 14px; box-sizing: border-box; outline: none; transition: all 0.3s;
            font-family: inherit; background-color: #fafafa;
        }
        .std-input:focus, .std-textarea:focus { border-color: #6a1b9a; background-color: #fff; box-shadow: 0 0 0 3px rgba(106, 27, 154, 0.1); }
        .std-textarea { resize: vertical; height: 100px; }
        .input-error { border: 2px solid #e74c3c !important; background-color: #fdf0f0; }
        .error-message { color: #e74c3c; font-size: 12px; margin-top: 5px; display: none; font-weight: bold; }

        /* Dropdown Grid */
        .form-grid-dynamic { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 600px) { .form-grid-dynamic { grid-template-columns: 1fr; } }

        /* Custom Dropdown CSS */
        .dropdown-wrapper { width: 100%; position: relative; }
        .custom-select { position: relative; user-select: none; width: 100%; }
        
        .select-box {
            width: 100%; background: #fafafa; border: 2px solid #eee;
            border-radius: 8px; padding: 12px 16px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 14px; box-sizing: border-box; transition: all 0.2s;
        }
        .custom-select.active .select-box { border: 2px solid #6a1b9a; background-color: #fff; box-shadow: 0 0 0 3px rgba(106, 27, 154, 0.1); }
        .custom-select.input-error .select-box { border: 2px solid #e74c3c; }

        .arrow { border: solid #888; border-width: 0 2px 2px 0; display: inline-block; padding: 3px; transform: rotate(45deg); transition: transform 0.3s; margin-top: -2px;}
        .custom-select.active .arrow { transform: rotate(-135deg); border-color: #6a1b9a; }

        .options-container {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 2px solid #eee; border-top: none; border-radius: 0 0 8px 8px;
            margin-top: 0px; z-index: 200; box-shadow: 0 10px 20px rgba(0,0,0,0.1); overflow: hidden;
            max-height: 250px; overflow-y: auto;
        }
        .custom-select.active .options-container { display: block; border-color: #6a1b9a; }
        
        .option-header { background-color: #6a1b9a; color: white; padding: 12px 16px; font-weight: bold; font-size: 14px;}
        .option { padding: 12px 16px; cursor: pointer; color: #333; transition: background 0.2s; font-weight: 500;}
        .option:hover { background-color: #f3e5f5; color: #6a1b9a; }

        /* Gizli B√∂l√ºmler */
        .category-specific-section {
            display: none; background-color: #f8f0ff; padding: 25px; border-radius: 12px; border: 2px dashed #d1c4e9; margin-top: 25px;
        }
        .specific-title { margin-top:0; color:#6a1b9a; font-size:16px; margin-bottom: 15px; font-weight: 700; }

        /* Fotoƒüraf Alanƒ± */
        .photo-upload-area {
            border: 2px dashed #d1c4e9; background-color: #f8f0ff; border-radius: 12px;
            padding: 40px; text-align: center; color: #6a1b9a; cursor: pointer; transition: all 0.3s;
        }
        .photo-upload-area:hover { background-color: #f0e0ff; border-color: #6a1b9a; }
        .photo-upload-area.input-error { border: 2px dashed #e74c3c; background-color: #fdf0f0; color: #e74c3c;}
        .image-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .preview-image { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .upload-icon { font-size: 36px; color: #6a1b9a; margin-bottom: 15px; display: block;}

        .agreement-wrapper { width: 100%; padding: 15px; margin-bottom: 10px; background: rgba(255,255,255,0.7); border-radius: 8px; box-sizing: border-box;}
        .checkbox-label { display: flex; align-items: flex-start; cursor: pointer; font-size: 14px; color: #555; line-height: 1.4; }
        .checkbox-input { width: 18px; height: 18px; margin-right: 12px; accent-color: #6a1b9a; cursor: pointer; margin-top: 2px; }
        .terms-link { color: #6a1b9a; text-decoration: underline; font-weight: 600; }

        .submit-btn {
            background: linear-gradient(to right, #6a1b9a, #8e24aa);
            color: white; border: none; padding: 16px 40px;
            font-size: 18px; font-weight: bold; border-radius: 10px; cursor: pointer;
            display: block; margin-top: 30px; width: 100%; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(106, 27, 154, 0.3);
        }
        .submit-btn:hover { background: linear-gradient(to right, #5e178a, #7b1fa2); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(106, 27, 154, 0.4); }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    </style>
</head>
<body>

    <header class="site-header">
        <a href="index.html" class="header-logo">SawyerS 2.el</a>
        <div class="header-menu">
            <a href="index.html" class="menu-item"><span style="font-size: 18px;">üîô</span><span class="menu-text">ƒ∞ptal</span></a>
        </div>
    </header>

    <div class="main-content-wrapper">

        <h1 class="page-title">√úcretsiz ƒ∞lan Olu≈ütur</h1>

        <div class="form-card">
            <h2 class="section-title">‚ú® 1. ƒ∞lan Kategorisi ve Detaylarƒ±</h2>
            
            <div class="form-group">
                <label class="label-text">ƒ∞lan Ba≈ülƒ±ƒüƒ± <span style="color:red">*</span></label>
                <input type="text" class="std-input" id="adTitle" placeholder="√ñrn: Az kullanƒ±lmƒ±≈ü √áalƒ±≈üma Masasƒ±">
                <div class="error-message">Ba≈ülƒ±k en az 5, en fazla 60 karakter olmalƒ±dƒ±r.</div>
            </div>

            <div class="form-group">
                <label class="label-text">Kategori Se√ßiniz <span style="color:red">*</span></label>
                <div class="dropdown-wrapper">
                    <div class="custom-select" id="main-category-select">
                        <div class="select-box">
                            <span class="selected-text">Kategori Se√ßiniz...</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="options-container">
                            <div class="option-header">T√ºm Kategoriler</div>
                            <div class="option" data-target="vasita-fields">üöó Vasƒ±ta</div>
                            <div class="option" data-target="emlak-fields">üè† Emlak</div>
                            <div class="option" data-target="elektronik-fields">üì± Elektronik</div>
                            <div class="option" data-target="ev-fields">üõãÔ∏è Ev E≈üyasƒ±</div>
                            <div class="option" data-target="giyim-fields">üëó Giyim & Moda</div>
                            <div class="option" data-target="yedek-fields">‚öôÔ∏è Yedek Par√ßa</div>
                            <div class="option" data-target="diger-fields">üì¶ Diƒüer / Her ≈ûey</div>
                        </div>
                    </div>
                    <div class="error-message">L√ºtfen bir kategori se√ßiniz.</div>
                </div>
            </div>

            <div id="vasita-fields" class="category-specific-section">
                <h3 class="specific-title">üöó Ara√ß √ñzellikleri</h3>
                <div class="form-grid-dynamic">
                    <div class="dropdown-wrapper"><label class="label-text">Marka</label><div class="custom-select"><div class="select-box"><span class="selected-text">Se√ßiniz</span><span class="arrow"></span></div><div class="options-container"><div class="option-header">Marka...</div><div class="option">BMW</div><div class="option">Mercedes</div><div class="option">Audi</div></div></div></div>
                    <div class="dropdown-wrapper"><label class="label-text">Yƒ±l</label><input type="number" class="std-input" placeholder="2023"></div>
                </div>
            </div>
            <div id="emlak-fields" class="category-specific-section">
                <h3 class="specific-title">üè† Emlak √ñzellikleri</h3>
                <div class="form-grid-dynamic">
                    <div class="dropdown-wrapper"><label class="label-text">Oda Sayƒ±sƒ±</label><input type="text" class="std-input" placeholder="3+1"></div>
                </div>
            </div>
            <div id="elektronik-fields" class="category-specific-section"><h3 class="specific-title">üì± Elektronik</h3></div>
            <div id="ev-fields" class="category-specific-section"></div>
            <div id="giyim-fields" class="category-specific-section"></div>
            <div id="yedek-fields" class="category-specific-section"></div>
            <div id="diger-fields" class="category-specific-section"></div>
        </div>

        <div class="form-card">
            <h2 class="section-title">üè∑Ô∏è 2. Fiyat ve ƒ∞leti≈üim</h2>
            <div class="form-group"><label class="label-text">Fiyat (TL) <span style="color:red">*</span></label><input type="number" class="std-input" id="adPrice" placeholder="0" min="1"><div class="error-message">Fiyat 0 veya daha d√º≈ü√ºk olamaz.</div></div>
            <div class="form-group"><label class="label-text">Cep Telefonu <span style="color:red">*</span></label><input type="tel" class="std-input" id="adPhone" placeholder="05XX XXX XX XX"><div class="error-message">Ge√ßerli numara giriniz.</div></div>
            <div class="form-group">
                <label class="label-text">A√ßƒ±klama <span style="color:red">*</span></label>
                <textarea class="std-textarea" id="adDesc" placeholder="Detaylar..."></textarea>
                <div style="text-align: right; font-size: 12px; color: #999;" id="charCount">0/500</div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="dropdown-wrapper"><label class="label-text">ƒ∞l</label><div class="custom-select" id="citySelect"><div class="select-box"><span class="selected-text">ƒ∞l Se√ßiniz</span><span class="arrow"></span></div><div class="options-container"><div class="option">ƒ∞stanbul</div><div class="option">Ankara</div><div class="option">ƒ∞zmir</div></div></div></div>
                <div class="dropdown-wrapper"><label class="label-text">ƒ∞l√ße</label><div class="custom-select" id="districtSelect"><div class="select-box"><span class="selected-text">ƒ∞l√ße Se√ßiniz</span><span class="arrow"></span></div><div class="options-container"><div class="option">Merkez</div><div class="option">Diƒüer</div></div></div></div>
            </div>
        </div>

        <div class="form-card">
            <h2 class="section-title">üì∑ 3. Fotoƒüraflar</h2>
            <input type="file" id="fileInput" multiple style="display: none;" accept="image/*">
            <div class="photo-upload-area" id="uploadArea">
                <span class="upload-icon">‚òÅÔ∏è</span>
                <strong>Fotoƒüraf y√ºklemek i√ßin tƒ±klayƒ±n</strong>
            </div>
            <div class="image-preview-container" id="previewContainer"></div>
            <div class="error-message" id="photoError">En az 1 fotoƒüraf y√ºklemelisiniz.</div>
        </div>

        <button class="submit-btn" id="publishBtn">‚ú® ƒ∞lanƒ± Yayƒ±nla</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- OTURUM KONTROL√ú ---
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('userName');
            
            if (!userId) {
                alert("ƒ∞lan vermek i√ßin l√ºtfen √∂nce Gƒ∞Rƒ∞≈û YAPINIZ.");
                window.location.href = "giris.html";
                return;
            }

            // --- UI ƒ∞≈ûLEMLERƒ∞ ---
            // Dropdown Mantƒ±ƒüƒ±
            const allSelects = document.querySelectorAll('.custom-select');
            const sections = {
                'emlak-fields': document.getElementById('emlak-fields'),
                'vasita-fields': document.getElementById('vasita-fields'),
                'elektronik-fields': document.getElementById('elektronik-fields'),
                'ev-fields': document.getElementById('ev-fields'),
                'giyim-fields': document.getElementById('giyim-fields'),
                'yedek-fields': document.getElementById('yedek-fields'),
                'diger-fields': document.getElementById('diger-fields')
            };
            let currentCategorySection = null;

            allSelects.forEach(select => {
                const selectBox = select.querySelector('.select-box');
                const options = select.querySelectorAll('.option');
                const selectedText = select.querySelector('.selected-text');

                selectBox.addEventListener('click', (e) => {
                    allSelects.forEach(other => { if(other !== select) other.classList.remove('active'); });
                    select.classList.toggle('active');
                    e.stopPropagation();
                });

                options.forEach(option => {
                    option.addEventListener('click', () => {
                        selectedText.innerText = option.innerText.replace(/[^a-zA-Zƒ∞ƒ±ƒûƒü√ú√º≈û≈ü√ñ√∂√á√ß0-9 &]/g, "").trim();
                        selectedText.style.color = "#000";
                        select.classList.remove('active');
                        select.classList.remove('input-error');

                        // Kategori Deƒüi≈üimi
                        if (select.id === 'main-category-select') {
                            const targetId = option.getAttribute('data-target');
                            for (let key in sections) { if(sections[key]) sections[key].style.display = 'none'; }
                            if (sections[targetId]) {
                                sections[targetId].style.display = 'block';
                                currentCategorySection = sections[targetId];
                            }
                            select.parentElement.querySelector('.error-message').style.display = 'none';
                        }
                    });
                });
            });

            document.addEventListener('click', () => { allSelects.forEach(s => s.classList.remove('active')); });

            // Karakter Sayacƒ±
            const descInput = document.getElementById('adDesc');
            const charCount = document.getElementById('charCount');
            descInput.addEventListener('input', function() {
                const len = this.value.length;
                charCount.innerText = len + "/500";
            });

            // Fotoƒüraf
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const previewContainer = document.getElementById('previewContainer');
            let hasPhoto = false;

            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                previewContainer.innerHTML = '';
                if(e.target.files.length > 0) {
                    hasPhoto = true;
                    uploadArea.classList.remove('input-error');
                    document.getElementById('photoError').style.display = 'none';
                    Array.from(e.target.files).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            const img = document.createElement('img');
                            img.src = ev.target.result;
                            img.classList.add('preview-image');
                            previewContainer.appendChild(img);
                        }
                        reader.readAsDataURL(file);
                    });
                }
            });

            // --- KAYDETME ---
            const publishBtn = document.getElementById('publishBtn');
            publishBtn.addEventListener('click', function() {
                let isValid = true;
                
                const title = document.getElementById('adTitle');
                if (title.value.trim().length < 5) { isValid = false; title.classList.add('input-error'); }
                else title.classList.remove('input-error');

                const price = document.getElementById('adPrice');
                if (price.value <= 0) { isValid = false; price.classList.add('input-error'); }
                else price.classList.remove('input-error');

                const catSelect = document.getElementById('main-category-select');
                if (catSelect.querySelector('.selected-text').innerText.includes("Se√ßiniz")) { isValid = false; catSelect.classList.add('input-error'); }
                else catSelect.classList.remove('input-error');

                if (!hasPhoto) { isValid = false; uploadArea.classList.add('input-error'); }

                if (isValid) {
                    publishBtn.disabled = true;
                    publishBtn.innerText = "Y√ºkleniyor...";

                    const formData = new FormData();
                    formData.append('sellerId', userId);
                    formData.append('sellerName', userName);
                    formData.append('title', title.value);
                    formData.append('category', catSelect.querySelector('.selected-text').innerText);
                    formData.append('price', price.value);
                    formData.append('phone', document.getElementById('adPhone').value);
                    formData.append('description', document.getElementById('adDesc').value);

                    const city = document.getElementById('citySelect').querySelector('.selected-text').innerText;
                    const district = document.getElementById('districtSelect').querySelector('.selected-text').innerText;
                    formData.append('city', city.includes('Se√ßiniz') ? '' : city);
                    formData.append('district', district.includes('Se√ßiniz') ? '' : district);

                    // Detaylar
                    let detailsObj = {};
                    if (currentCategorySection) {
                        currentCategorySection.querySelectorAll('input.std-input').forEach(inp => {
                            if(inp.value) detailsObj[inp.parentElement.querySelector('.label-text').innerText] = inp.value;
                        });
                    }
                    formData.append('details', JSON.stringify(detailsObj));

                    // Dosyalar
                    for (let i = 0; i < fileInput.files.length; i++) {
                        formData.append('photos', fileInput.files[i]);
                    }

                    // Backend ƒ∞steƒüi
                    fetch('http://localhost:5000/api/ilan-ver', {
                        method: 'POST',
                        body: formData
                    })
                    .then(res => res.json())
                    .then(data => {
                        if(data.error) {
                            alert("Hata: " + data.error);
                            publishBtn.disabled = false;
                        } else {
                            alert("‚ú® ƒ∞lan Ba≈üarƒ±yla Yayƒ±nlandƒ±!");
                            window.location.href = "index.html"; 
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Baƒülantƒ± hatasƒ±!");
                        publishBtn.disabled = false;
                    });
                } else {
                    alert("L√ºtfen t√ºm zorunlu alanlarƒ± doldurun.");
                }
            });

        });
    </script>
</body>
</html>